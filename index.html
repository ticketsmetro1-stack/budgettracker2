<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Budget PWA â€” Goals</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #f5f6fa; }
    header { padding: 10px; background: #fff; display: flex; align-items: center; justify-content: space-between; }
    h1 { font-size: 20px; margin: 0; }
    .goal-card {
      background: #fff;
      padding: 12px;
      margin: 10px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .goal-header { display: flex; justify-content: space-between; align-items: center; }
    .goal-title { font-weight: bold; font-size: 18px; }
    .goal-actions button { border: none; background: none; font-size: 18px; cursor: pointer; margin-left: 6px; }
    .progress-bar { background: #eee; height: 6px; border-radius: 6px; margin-top: 6px; overflow: hidden; }
    .progress { background: #4caf50; height: 100%; width: 0; transition: width 0.3s; }
    .transactions { margin-top: 8px; font-size: 14px; }
    .tx-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; border-bottom: 1px solid #eee; }
    .tx-note { color: #555; }
    .tx-amount { font-weight: bold; }
    .tx-delete { color: red; cursor: pointer; margin-left: 10px; }
    .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); 
             align-items:center; justify-content:center; }
    .modal-content { background:#fff; padding:20px; border-radius:10px; width:90%; max-width:400px; }
    .modal-content input { display:block; margin:8px 0; width:100%; padding:8px; font-size:16px; }
    .modal-actions { display:flex; justify-content:flex-end; gap:10px; margin-top:12px; }
    .modal-actions button { padding:6px 14px; border:none; border-radius:6px; font-size:15px; cursor:pointer; }
    .cancel { background:#eee; }
    .add { background:#4caf50; color:#fff; }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ’° Budget â€” Goals</h1>
    <button onclick="toggleView()">ðŸ”„</button>
  </header>

  <div id="goals"></div>

  <!-- Add Transaction Modal -->
  <div class="modal" id="transactionModal">
    <div class="modal-content">
      <h2 id="modalTitle">Add Transaction</h2>
      <input type="number" id="txAmount" placeholder="Amount">
      <input type="text" id="txNote" placeholder="Note">
      <input type="date" id="txDate">
      <div class="modal-actions">
        <button class="cancel" onclick="closeTransactionModal()">Cancel</button>
        <button class="add" onclick="confirmTransaction()">Add</button>
      </div>
    </div>
  </div>

  <script>
    let goals = JSON.parse(localStorage.getItem("goals") || "[]");
    let activeGoalIndex = null;
    let subtractMode = false;
    let showPercentage = false;

    function saveGoals() {
      localStorage.setItem("goals", JSON.stringify(goals));
    }

    function renderGoals() {
      const container = document.getElementById("goals");
      container.innerHTML = "";
      goals.forEach((g, i) => {
        let total = g.amount + g.transactions.reduce((a,t) => a + t.amount, 0);

        const card = document.createElement("div");
        card.className = "goal-card";

        const header = document.createElement("div");
        header.className = "goal-header";

        header.innerHTML = `
          <span class="goal-title">${g.name}</span>
          <div class="goal-actions">
            <button onclick="openTransactionModal(${i}, false)">âž•</button>
            ${(!g.target || g.target === 0) ? `<button onclick="openTransactionModal(${i}, true)">âž–</button>` : ""}
            <button onclick="deleteGoal(${i})">ðŸ—‘</button>
          </div>
        `;

        card.appendChild(header);

        let progressText = "";
        let remainingText = "";
        let percent = 0;

        if (g.target && g.target > 0) {
          percent = Math.min((total / g.target) * 100, 100);
          if (showPercentage) {
            progressText = percent.toFixed(1) + "%";
          } else {
            progressText = `${g.currency} ${total} / ${g.currency} ${g.target}`;
          }
          remainingText = `Remaining: ${g.currency} ${g.target - total}`;
        } else {
          // deposit-only
          progressText = `Collected: ${g.currency} ${total}`;
        }

        const info = document.createElement("div");
        info.innerHTML = `
          <div>${progressText}</div>
          ${remainingText ? `<div>${remainingText}</div>` : ""}
          <div class="progress-bar"><div class="progress" style="width:${percent}%"></div></div>
        `;
        card.appendChild(info);

        // Transactions list
        if (g.transactions.length > 0) {
          const txList = document.createElement("div");
          txList.className = "transactions";
          g.transactions.forEach((t, j) => {
            const tx = document.createElement("div");
            tx.className = "tx-item";
            tx.innerHTML = `
              <div>
                <span class="tx-note">${t.note || "No note"}</span> â€” <small>${t.date}</small>
              </div>
              <div>
                <span class="tx-amount" style="color:${t.amount<0?'red':'green'}">
                  ${g.currency} ${t.amount}
                </span>
                <span class="tx-delete" onclick="deleteTransaction(${i},${j})">âœ–</span>
              </div>
            `;
            txList.appendChild(tx);
          });
          card.appendChild(txList);
        }

        container.appendChild(card);
      });
    }

    function openTransactionModal(goalIndex, isSubtract) {
      activeGoalIndex = goalIndex;
      subtractMode = isSubtract;
      document.getElementById("txAmount").value = "";
      document.getElementById("txNote").value = "";
      document.getElementById("txDate").valueAsDate = new Date();
      document.getElementById("modalTitle").textContent = subtractMode ? "Subtract Transaction" : "Add Transaction";
      document.getElementById("transactionModal").style.display = "flex";
    }

    function closeTransactionModal() {
      document.getElementById("transactionModal").style.display = "none";
    }

    function confirmTransaction() {
      const amt = parseFloat(document.getElementById("txAmount").value || 0);
      if (!amt) return;
      const note = document.getElementById("txNote").value;
      const date = document.getElementById("txDate").value;

      goals[activeGoalIndex].transactions.push({
        amount: subtractMode ? -Math.abs(amt) : amt,
        note, date
      });
      saveGoals();
      renderGoals();
      closeTransactionModal();
    }

    function deleteGoal(i) {
      if (confirm("Delete this goal?")) {
        goals.splice(i, 1);
        saveGoals();
        renderGoals();
      }
    }

    function deleteTransaction(goalIndex, txIndex) {
      if (confirm("Delete this transaction?")) {
        goals[goalIndex].transactions.splice(txIndex, 1);
        saveGoals();
        renderGoals();
      }
    }

    function toggleView() {
      showPercentage = !showPercentage;
      renderGoals();
    }

    // Demo: preload some goals if empty
    if (goals.length === 0) {
      goals = [
        { name: "BM", amount: 0, target: 0, currency: "EGP", transactions: [] },
        { name: "Alahly", amount: 0, target: 5000, currency: "EGP", transactions: [] }
      ];
      saveGoals();
    }

    renderGoals();
  </script>
</body>
</html>
