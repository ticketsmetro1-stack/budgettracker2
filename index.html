<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Budget ‚Äî Goals</title>
  <style>
    :root{
      --bg:#f4f6f8; --card:#fff; --muted:#6b7280; --accent:#2563eb; --radius:12px; --text:#111827;
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    body{margin:0;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
    .app{max-width:980px;margin:18px auto;padding:16px}
    header{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    h1{font-size:20px;margin:0}
    .controls{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
    .btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--accent);border:1px solid #e6eefc}
    .inline-form{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .inline-form input,.inline-form select{padding:6px 8px;border-radius:8px;border:1px solid #ccc}
    .group{margin-top:18px}
    .group-header{display:flex;align-items:center;justify-content:space-between;padding:6px 0}
    .group-title{font-weight:700}
    .goals-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media(min-width:560px){ .goals-grid{grid-template-columns:repeat(auto-fill,minmax(260px,1fr))} }
    .card{display:flex;flex-direction:column;justify-content:space-between;padding:12px;border-radius:12px;background:var(--card);box-shadow:0 6px 18px rgba(11,12,30,0.04)}
    .top{display:flex;gap:10px;align-items:center}
    .badge{width:44px;height:44px;border-radius:10px;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
    .meta{flex:1}
    .name{font-weight:700}
    .note{font-size:12px;color:var(--muted)}
    .amount{font-weight:800;margin-top:8px}
    .remaining{font-size:13px;color:var(--muted)}
    .progress{height:8px;background:#eef3ff;border-radius:8px;overflow:hidden;margin-top:8px}
    .progress > div{height:100%;transition:width .25s}
    .actions{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap}
    .action-btn{padding:6px 8px;border-radius:8px;border:none;background:#f3f4f6;cursor:pointer}
    .goal-summary{display:none;padding:8px;margin-top:8px;border-radius:8px;background:rgba(0,0,0,0.02);font-size:13px}
    .tx-row{display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(0,0,0,0.03)}
    .tx-left{font-size:13px;color:var(--muted)}
    .tx-actions button{background:none;border:none;cursor:pointer}
    footer{margin-top:20px;color:var(--muted);font-size:13px;text-align:center}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(3,6,23,0.45);z-index:60}
    .modal.show{display:flex}
    .sheet{background:var(--card);padding:16px;border-radius:12px;min-width:300px;max-width:460px}
    .sheet h3{margin:0 0 12px;font-size:18px}
    .sheet input{width:100%;padding:8px;margin-bottom:10px;border:1px solid #ccc;border-radius:8px}
    .sheet .btn-row{display:flex;justify-content:flex-end;gap:8px}
    .small-muted{font-size:12px;color:var(--muted);margin-top:6px}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>üí∞ Budget ‚Äî Goals</h1>
      <div class="controls">
        <button class="btn secondary" onclick="toggleTheme()">üåì</button>
        <button class="btn" onclick="exportJSON()">Export JSON</button>
        <button class="btn" onclick="importJSON()">Import</button>
        <button class="btn" onclick="exportCSV()">Export CSV</button>
      </div>
    </header>

    <!-- Add / Edit Goal Form -->
    <div class="inline-form">
      <input id="goalName" placeholder="Goal Name" />
      <div style="display:flex;align-items:center;gap:4px;">
        <input id="goalAmount" type="number" placeholder="Amount" />
        <select id="goalAmountCurrency">
          <option value="EGP" selected>EGP</option>
          <option value="USD">USD</option>
          <option value="SAR">SAR</option>
        </select>
      </div>
      <div style="display:flex;align-items:center;gap:4px;">
        <input id="goalTarget" type="number" placeholder="Target (optional)" />
        <select id="goalTargetCurrency">
          <option value="EGP" selected>EGP</option>
          <option value="USD">USD</option>
          <option value="SAR">SAR</option>
        </select>
      </div>
      <input id="dueValue" type="date" />
      <input list="groupList" id="goalGroup" placeholder="Group (default: My Goals)" />
      <datalist id="groupList"></datalist>
      <input id="goalColor" type="color" value="#22c55e" />
      <button class="btn" onclick="saveGoal()" id="addGoalBtn">Add Goal</button>
    </div>

    <div id="groups"></div>
    <footer>Budget PWA ‚Äî Offline Ready</footer>
  </div>

  <!-- Delete Modal -->
  <div id="deleteModal" class="modal">
    <div class="sheet">
      <p>Are you sure you want to delete this goal?</p>
      <div class="btn-row">
        <button class="btn secondary" onclick="closeModal('deleteModal')">Cancel</button>
        <button class="btn" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>

  <!-- Transaction Modal -->
  <div id="transactionModal" class="modal">
    <div class="sheet">
      <h3 id="txModalTitle">Add Transaction</h3>
      <input id="txAmount" type="number" placeholder="Amount" />
      <input id="txCategory" placeholder="Category (e.g. Food, Bills)" />
      <input id="txDate" type="date" />
      <div class="btn-row">
        <button class="btn secondary" onclick="closeModal('transactionModal')">Cancel</button>
        <button class="btn" id="confirmTxBtn">Add</button>
      </div>
      <div class="small-muted" id="txCurrencyHint"></div>
    </div>
  </div>

  <script>
    // --- Data ---
    let goals = JSON.parse(localStorage.getItem('pwa-goals')||'[]');

    // Keep editing state and transaction state
    let editingGoalId = null;
    let deletingGoalId = null;
    let txGoalId = null;
    let txSubtractMode = false;
    let showPercentage = false;

    // Helpers
    function formatNumber(n){
      if (Number.isInteger(n)) return String(n);
      return Number(n).toFixed(2);
    }
    function formatCurrencySymbol(code){
      // Keep simple: show code (EGP, USD, SAR)
      return code || 'EGP';
    }

    function getGroups(){
      const unique = [...new Set(goals.map(g => g.group || 'My Goals'))];
      return unique.length ? unique : ['My Goals'];
    }
    function renderGroupsDropdown(){
      const list = document.getElementById('groupList');
      if(!list) return;
      list.innerHTML = '';
      getGroups().forEach(g => {
        const o = document.createElement('option'); o.value = g; list.appendChild(o);
      });
    }

    // --- Render ---
    function renderGoals(){
      renderGroupsDropdown();
      const groupsDiv = document.getElementById('groups');
      groupsDiv.innerHTML = '';

      const groupsMap = {};
      goals.forEach(g => {
        const grp = g.group || 'My Goals';
        if(!groupsMap[grp]) groupsMap[grp] = [];
        groupsMap[grp].push(g);
      });

      Object.keys(groupsMap).forEach(groupName => {
        const groupEl = document.createElement('div'); groupEl.className = 'group';
        groupEl.innerHTML = `<div class="group-header"><span class="group-title">${groupName}</span></div>`;
        const grid = document.createElement('div'); grid.className = 'goals-grid';

        groupsMap[groupName].forEach(goal => {
          // compute saved: base amount + sum(transactions)
          const base = Number(goal.amount || 0);
          const txTotal = (goal.transactions || []).reduce((s,t) => s + Number(t.amount || 0), 0);
          const saved = base + txTotal;

          const target = Number(goal.target || 0);
          const hasTarget = target > 0;
          const pct = hasTarget ? Math.min((saved / target) * 100, 100) : 0;

          const card = document.createElement('div'); card.className = 'card';
          card.innerHTML = `
            <div class="top">
              <div class="badge" style="background:${goal.color||'#2563eb'}">${(goal.name||'')[0]||'G'}</div>
              <div class="meta">
                <div class="name">${goal.name}</div>
                <div class="note">Due: ${goal.due||''}</div>
              </div>
            </div>

            <div class="amount">
              ${ hasTarget 
                  ? `${formatCurrencySymbol(goal.amountCurrency || goal.currency || 'EGP')} ${formatNumber(saved)} / ${formatCurrencySymbol(goal.targetCurrency || goal.currency || 'EGP')} ${formatNumber(target)}`
                  : `${formatCurrencySymbol(goal.amountCurrency || goal.currency || 'EGP')} ${formatNumber(saved)}`
              }
            </div>

            <div class="remaining">
              ${ hasTarget ? `Remaining: ${formatCurrencySymbol(goal.targetCurrency || 'EGP')} ${formatNumber(Math.max(target - saved, 0))}`
                           : `Collected: ${formatCurrencySymbol(goal.amountCurrency || 'EGP')} ${formatNumber(saved)}` }
            </div>

            <div class="progress"><div style="width:${pct}%;background:${goal.color||'var(--accent)'}"></div></div>
            <div style="font-size:12px;margin-top:6px;color:var(--muted)">${hasTarget ? pct.toFixed(1) + '%' : ''}</div>

            <div class="actions">
              <button class="action-btn" onclick="openTransactionModal('${goal.id}', false)">‚ûï</button>
              ${ !hasTarget ? `<button class="action-btn" onclick="openTransactionModal('${goal.id}', true)">‚ûñ</button>` : '' }
              <button class="action-btn" onclick="startEditGoal('${goal.id}')">‚úèÔ∏è</button>
              <button class="action-btn" onclick="openDeleteModal('${goal.id}')">üóëÔ∏è</button>
              <button class="action-btn" onclick="toggleSummary('${goal.id}')">‚ÑπÔ∏è</button>
            </div>

            <div id="summary-${goal.id}" class="goal-summary">
              ${(goal.transactions || []).length ? (goal.transactions || []).map((t, idx) => `
                <div class="tx-row">
                  <div class="tx-left">${t.date} ‚Äî ${t.category || 'General'}</div>
                  <div class="tx-actions">
                    <span style="margin-right:10px;color:${t.amount<0?'#cc0000':'#0b8a40'}">${formatCurrencySymbol(goal.amountCurrency||'EGP')} ${formatNumber(t.amount)}</span>
                    <button title="Delete transaction" onclick="deleteTransaction('${goal.id}', ${idx})">‚úñ</button>
                  </div>
                </div>
              `).join('') : 'No transactions'}
            </div>
          `;
          grid.appendChild(card);
        });

        groupEl.appendChild(grid);
        groupsDiv.appendChild(groupEl);
      });
    }

    // --- Goal CRUD ---
    function saveGoal(){
      const name = document.getElementById('goalName').value.trim();
      if(!name){ alert('Please enter a goal name'); return; }
      const amount = Number(document.getElementById('goalAmount').value) || 0;
      const target = Number(document.getElementById('goalTarget').value) || 0;
      const due = document.getElementById('dueValue').value || '';
      const color = document.getElementById('goalColor').value || '#22c55e';
      const group = (document.getElementById('goalGroup')?.value?.trim()) || 'My Goals';
      const amountCurrency = document.getElementById('goalAmountCurrency')?.value || 'EGP';
      const targetCurrency = document.getElementById('goalTargetCurrency')?.value || amountCurrency;

      if(editingGoalId){
        const g = goals.find(x=>x.id === editingGoalId);
        if(!g) return;
        g.name = name;
        g.amount = amount;
        g.target = target;
        g.due = due;
        g.color = color;
        g.group = group;
        g.amountCurrency = amountCurrency;
        g.targetCurrency = targetCurrency;
        editingGoalId = null;
        document.getElementById('addGoalBtn').textContent = 'Add Goal';
      } else {
        goals.push({
          id: Date.now().toString(),
          name, amount, target, due, color, group,
          amountCurrency, targetCurrency,
          transactions: []
        });
      }

      localStorage.setItem('pwa-goals', JSON.stringify(goals));
      clearForm();
      renderGoals();
    }

    function startEditGoal(id){
      const g = goals.find(x=>x.id===id);
      if(!g) return;
      editingGoalId = id;
      document.getElementById('goalName').value = g.name || '';
      document.getElementById('goalAmount').value = g.amount || '';
      document.getElementById('goalTarget').value = g.target || '';
      document.getElementById('dueValue').value = g.due || '';
      if(document.getElementById('goalColor')) document.getElementById('goalColor').value = g.color || '#22c55e';
      if(document.getElementById('goalGroup')) document.getElementById('goalGroup').value = g.group || 'My Goals';
      if(document.getElementById('goalAmountCurrency')) document.getElementById('goalAmountCurrency').value = g.amountCurrency || 'EGP';
      if(document.getElementById('goalTargetCurrency')) document.getElementById('goalTargetCurrency').value = g.targetCurrency || g.amountCurrency || 'EGP';
      document.getElementById('addGoalBtn').textContent = 'Update Goal';
    }

    function openDeleteModal(id){
      deletingGoalId = id;
      document.getElementById('deleteModal').classList.add('show');
      document.getElementById('confirmDeleteBtn').onclick = confirmDelete;
    }
    function confirmDelete(){
      goals = goals.filter(g => g.id !== deletingGoalId);
      localStorage.setItem('pwa-goals', JSON.stringify(goals));
      deletingGoalId = null;
      closeModal('deleteModal');
      renderGoals();
    }
    function closeModal(id){ document.getElementById(id).classList.remove('show'); }
    function clearForm(){
      document.getElementById('goalName').value = '';
      document.getElementById('goalAmount').value = '';
      document.getElementById('goalTarget').value = '';
      document.getElementById('dueValue').value = '';
      if(document.getElementById('goalColor')) document.getElementById('goalColor').value = '#22c55e';
      if(document.getElementById('goalGroup')) document.getElementById('goalGroup').value = '';
      if(document.getElementById('goalAmountCurrency')) document.getElementById('goalAmountCurrency').value = 'EGP';
      if(document.getElementById('goalTargetCurrency')) document.getElementById('goalTargetCurrency').value = 'EGP';
    }

    // --- Transactions ---
    function openTransactionModal(goalId, subtract=false){
      txGoalId = goalId;
      txSubtractMode = !!subtract;
      // clear inputs each time -> prevents leak between opens
      document.getElementById('txAmount').value = '';
      document.getElementById('txCategory').value = '';
      document.getElementById('txDate').value = ''; // user chooses date
      document.getElementById('txModalTitle').textContent = subtract ? 'Subtract Transaction' : 'Add Transaction';
      const goal = goals.find(g => g.id === goalId);
      document.getElementById('txCurrencyHint').textContent = goal ? `Recording in ${goal.amountCurrency || goal.currency || 'EGP'}` : '';
      document.getElementById('transactionModal').classList.add('show');

      // bind confirm (overwrite previous)
      document.getElementById('confirmTxBtn').onclick = confirmAddTransaction;

      setTimeout(()=>document.getElementById('txAmount').focus(), 100);
    }

    function confirmAddTransaction(){
      const raw = document.getElementById('txAmount').value;
      const amt = Number(raw || 0);
      if(!raw || isNaN(amt) || amt === 0){ alert('Enter a non-zero amount'); return; }
      const cat = document.getElementById('txCategory').value.trim() || 'General';
      const date = document.getElementById('txDate').value || new Date().toISOString().slice(0,10);

      const g = goals.find(x => x.id === txGoalId);
      if(!g){ closeModal('transactionModal'); return; }

      const value = txSubtractMode ? -Math.abs(amt) : Number(amt);
      g.transactions = g.transactions || [];
      g.transactions.push({ amount: value, category: cat, date });

      // persist and cleanup
      localStorage.setItem('pwa-goals', JSON.stringify(goals));
      // clear modal inputs to avoid leakage
      document.getElementById('txAmount').value = '';
      document.getElementById('txCategory').value = '';
      document.getElementById('txDate').value = '';
      txGoalId = null; txSubtractMode = false;
      closeModal('transactionModal');
      renderGoals();
    }

    function deleteTransaction(goalId, txIndex){
      const g = goals.find(x=>x.id===goalId);
      if(!g || !g.transactions || !g.transactions[txIndex]) return;
      if(!confirm('Delete this transaction?')) return;
      g.transactions.splice(txIndex, 1);
      localStorage.setItem('pwa-goals', JSON.stringify(goals));
      renderGoals();
    }

    // --- other utilities ---
    function toggleSummary(id){
      const el = document.getElementById('summary-' + id);
      if(!el) return;
      el.style.display = el.style.display === 'block' ? 'none' : 'block';
    }
    function toggleTheme(){ document.body.dataset.theme = document.body.dataset.theme==='dark' ? 'light' : 'dark'; }

    function toggleView(){ showPercentage = !showPercentage; renderGoals(); }

    function exportJSON(){
      const blob = new Blob([JSON.stringify(goals)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'goals.json'; a.click();
    }
    function importJSON(){
      const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
      inp.onchange = e => { const f = e.target.files[0]; const r = new FileReader(); r.onload = () => { goals = JSON.parse(r.result); localStorage.setItem('pwa-goals', JSON.stringify(goals)); renderGoals(); }; r.readAsText(f); };
      inp.click();
    }
    function exportCSV(){
      const rows = [["Name","Saved","Target","Due","Group","AmountCurrency","TargetCurrency"]];
      goals.forEach(g=>{
        const base = Number(g.amount||0);
        const txTotal = (g.transactions||[]).reduce((s,t)=>s+Number(t.amount||0),0);
        const saved = base + txTotal;
        rows.push([g.name, saved, g.target||0, g.due||'', g.group||'My Goals', g.amountCurrency||'EGP', g.targetCurrency||g.amountCurrency||'EGP']);
      });
      const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'goals.csv'; a.click();
    }

    // Expose some handlers for inline onclick
    window.openTransactionModal = openTransactionModal;
    window.deleteTransaction = deleteTransaction;
    window.startEditGoal = startEditGoal;
    window.openDeleteModal = openDeleteModal;
    window.toggleSummary = toggleSummary;

    // Render initially
    renderGoals();

    // Optional: register service worker (if sw.js exists)
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('sw.js').catch(()=>{/* ignore */});
    }
  </script>
</body>
</html>
